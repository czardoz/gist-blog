<!DOCTYPE html><html><head><meta charst="utf-8"><title>GistBlog</title><!--link(href="#{meta.site_url}/assets/bootstrap/css/bootstrap.min.css",rel="stylesheet")--><link href="http://blog.neekey.me/gist-blog/assets/common/markdown.css" rel="stylesheet"><link href="http://blog.neekey.me/gist-blog/assets/common/screen.css" rel="stylesheet"><link rel="stylesheet" href="http://yandex.st/highlightjs/7.3/styles/rainbow.min.css">
<script src="http://yandex.st/highlightjs/7.3/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script></head><body><header><div class="avatar"><img src="https://secure.gravatar.com/avatar/8896cc725e36350023e7f41f0455b8aa?d=https://a248.e.akamai.net/assets.github.com%2Fimages%2Fgravatars%2Fgravatar-user-420.png"></div><h1 class="site-title"><a href="http://blog.neekey.me/gist-blog">Neekey</a></h1><p class="site-description">在此记录我的学习&amp;生活.</p></header><div class="post-block"><p class="post-title">在Meter.methods()中进行异步操作</p><p class="update-date">2013-03-09T08:23:04Z</p><div class="post-md-content"><p>相关issue: <a href="https://github.com/meteor/meteor/issues/74#issuecomment-14659538">https://github.com/meteor/meteor/issues/74#issuecomment-14659538</a>

</p>
<p>方法是使用<a href="https://github.com/laverdet/node-fibers">fiber</a>模块来实现同步阻塞。

</p>
<p>首先先利用该模块封装一个同步执行方法：

</p>
<pre><code class="lang-js">syncRun = function(func) {
    var Fiber = NodeModules.require( &#39;fibers&#39; );
    var fiber = Fiber.current;
    var result, error;

    var args = Array.prototype.slice.call(arguments, 1);

    func.apply(undefined, [cb].concat(args));
    Fiber.yield();
    if (error) throw new Meteor.Error(500, error.code, error.toString());
    return result;

    function cb(err, res) {
        error = err;
        result = res;
        fiber.run();
    }
};</code></pre>
<p>直接看下使用举例：

</p>
<pre><code class="lang-js">Meteor.methods({
  foo: function(){
    this.unblock();
    var myTask = function( done, num ){
      setTimeout(function(){
        done( null, num);  
      }, num );
    }

    return syncRun( myTask, 1000 );
  }
})</code></pre>
</div></div></body></html>